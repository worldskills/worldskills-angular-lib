"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.WsService = exports.NO_SUBJECT = exports.LOADER_ONLY = exports.FULL = exports.isRequestOptions = exports.isFetchParams = exports.isMulticastOptions = void 0;
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
function isMulticastOptions(object) {
    return object && ('subject' in object || 'loader' in object || 'subscription' in object || 'onError' in object);
}
exports.isMulticastOptions = isMulticastOptions;
// Fetch params can be empty and probably is most of the time, so hard to check this in a signature
function isFetchParams(object) {
    return object && ('limit' in object || 'offset' in object || 'sort' in object || 'l' in object);
}
exports.isFetchParams = isFetchParams;
function isRequestOptions(object) {
    return object && ('url' in object);
}
exports.isRequestOptions = isRequestOptions;
exports.FULL = {
    subject: true,
    loader: true,
    subscription: true
};
exports.LOADER_ONLY = {
    loader: true
};
exports.NO_SUBJECT = {
    loader: true,
    subscription: true
};
class WsService {
    constructor() {
        this.loaders = new rxjs_1.BehaviorSubject(0);
        this.subscription = null;
        this.subject = new rxjs_1.ReplaySubject(1);
        this.loading = new rxjs_1.ReplaySubject(1);
        this.loaders.subscribe(numLoaders => this.loading.next(numLoaders !== 0));
    }
    resolveArgs(p1, p2, p3, defaultMulticastOptions, defaultFetchParams) {
        let fetchParams;
        let multicastOptions;
        let requestOptions;
        if (isRequestOptions(p3)) {
            fetchParams = p1;
            multicastOptions = p2;
            requestOptions = p3;
        }
        else if (isRequestOptions(p2)) {
            requestOptions = p2;
            if (isMulticastOptions(p1)) {
                multicastOptions = p1;
            }
            else if (!isMulticastOptions(p1)) {
                fetchParams = p1;
            }
        }
        else if (isRequestOptions(p1)) {
            requestOptions = p1;
        }
        else {
            if (isMulticastOptions(p2) && !isMulticastOptions(p1)) {
                fetchParams = p1;
                multicastOptions = p2;
            }
            else {
                if (isMulticastOptions(p1)) {
                    multicastOptions = p1;
                }
                else if (!isMulticastOptions(p1)) {
                    fetchParams = p1;
                }
            }
        }
        if (fetchParams === undefined) {
            fetchParams = defaultFetchParams;
        }
        if (multicastOptions === undefined) {
            multicastOptions = defaultMulticastOptions;
        }
        if (requestOptions === undefined) {
            requestOptions = {};
        }
        return {
            fetchParams,
            multicastOptions,
            requestOptions
        };
    }
    incrementLoader() {
        this.loaders.pipe(operators_1.take(1)).subscribe(v => {
            this.loaders.next(++v);
        });
    }
    decrementLoader() {
        this.loaders.pipe(operators_1.take(1)).subscribe(v => {
            const loaders = Math.max(0, v - 1);
            this.loaders.next(loaders);
        });
    }
    multicast(observable, options = exports.FULL) {
        const { loader, subject, subscription, onError } = options;
        if (loader) {
            this.incrementLoader();
        }
        if (subscription && this.subscription) {
            if (loader && !this.subscription.closed) {
                this.decrementLoader();
                this.subscription.unsubscribe();
            }
        }
        const s = observable.subscribe(value => {
            if (loader) {
                this.decrementLoader();
            }
            if (subject) {
                this.subject.next(value);
            }
        }, error => {
            if (loader) {
                this.decrementLoader();
            }
            if (onError) {
                onError(error);
            }
        });
        if (subscription) {
            this.subscription = s;
        }
    }
    request(observable, options = exports.FULL) {
        this.multicast(observable, options);
        return observable;
    }
    requestMany(observables, options = exports.NO_SUBJECT) {
        const forkJoined = rxjs_1.forkJoin(observables);
        this.multicast(forkJoined, options);
        return forkJoined;
    }
}
exports.WsService = WsService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3Muc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3dvcmxkc2tpbGxzLWFuZ3VsYXItbGliL3NyYy9saWIvY29tbW9uL3V0aWwvd3Muc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrQkFBMEY7QUFDMUYsOENBQXNDO0FBbUN0QyxTQUFnQixrQkFBa0IsQ0FBQyxNQUFXO0lBQzVDLE9BQU8sTUFBTSxJQUFJLENBQUMsU0FBUyxJQUFJLE1BQU0sSUFBSSxRQUFRLElBQUksTUFBTSxJQUFJLGNBQWMsSUFBSSxNQUFNLElBQUksU0FBUyxJQUFJLE1BQU0sQ0FBQyxDQUFDO0FBQ2xILENBQUM7QUFGRCxnREFFQztBQUVELG1HQUFtRztBQUNuRyxTQUFnQixhQUFhLENBQUMsTUFBVztJQUN2QyxPQUFPLE1BQU0sSUFBSSxDQUFDLE9BQU8sSUFBSSxNQUFNLElBQUksUUFBUSxJQUFJLE1BQU0sSUFBSSxNQUFNLElBQUksTUFBTSxJQUFJLEdBQUcsSUFBSSxNQUFNLENBQUMsQ0FBQztBQUNsRyxDQUFDO0FBRkQsc0NBRUM7QUFFRCxTQUFnQixnQkFBZ0IsQ0FBQyxNQUFXO0lBQzFDLE9BQU8sTUFBTSxJQUFJLENBQUMsS0FBSyxJQUFJLE1BQU0sQ0FBQyxDQUFDO0FBQ3JDLENBQUM7QUFGRCw0Q0FFQztBQU1ZLFFBQUEsSUFBSSxHQUFxQjtJQUNwQyxPQUFPLEVBQUUsSUFBSTtJQUNiLE1BQU0sRUFBRSxJQUFJO0lBQ1osWUFBWSxFQUFFLElBQUk7Q0FDbkIsQ0FBQztBQUVXLFFBQUEsV0FBVyxHQUFxQjtJQUMzQyxNQUFNLEVBQUUsSUFBSTtDQUNiLENBQUM7QUFFVyxRQUFBLFVBQVUsR0FBcUI7SUFDMUMsTUFBTSxFQUFFLElBQUk7SUFDWixZQUFZLEVBQUUsSUFBSTtDQUNuQixDQUFDO0FBRUYsTUFBc0IsU0FBUztJQU83QjtRQUxRLFlBQU8sR0FBRyxJQUFJLHNC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TyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVTLFdBQVcsQ0FBQyxXQUFpQyxFQUFFLFVBQTRCLGtCQUFVO1FBQzdGLE1BQU0sVUFBVSxHQUFHLGVBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN6QyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNwQyxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0NBRUY7QUF6SEQsOEJBeUhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBmb3JrSm9pbiwgT2JzZXJ2YWJsZSwgUmVwbGF5U3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vKipcbiAqIEV4YW1wbGUgdXNhZ2U6XG4gKlxuICogZmV0Y2goZXZlbnRJZDogbnVtYmVyLCByT3B0PzogUmVxdWVzdE9wdGlvbnMpOiBPYnNlcnZhYmxlPFQ+O1xuICogZmV0Y2goZXZlbnRJZDogbnVtYmVyLCBwYXJhbXM6IEZldGNoUGFyYW1zLCByT3B0PzogUmVxdWVzdE9wdGlvbnMpOiBPYnNlcnZhYmxlPFQ+O1xuICogZmV0Y2goZXZlbnRJZDogbnVtYmVyLCBtT3B0OiBNdWx0aWNhc3RPcHRpb25zLCByT3B0PzogUmVxdWVzdE9wdGlvbnMpOiBPYnNlcnZhYmxlPFQ+O1xuICogZmV0Y2goZXZlbnRJZDogbnVtYmVyLCBwYXJhbXM6IEZldGNoUGFyYW1zLCBtT3B0OiBNdWx0aWNhc3RPcHRpb25zLCByT3B0PzogUmVxdWVzdE9wdGlvbnMpOiBPYnNlcnZhYmxlPFQ+O1xuICogZmV0Y2goZXZlbnRJZDogbnVtYmVyLCBwMTogUDEsIHAyPzogUDIsIHAzPzogUDMpOiBPYnNlcnZhYmxlPFQ+IHtcbiAqICAgY29uc3Qge2ZldGNoUGFyYW1zLCBtdWx0aWNhc3RPcHRpb25zLCByZXF1ZXN0T3B0aW9uc30gPSB0aGlzLnJlc29sdmVBcmdzKHAxLCBwMiwgcDMsIEZVTEwpO1xuICogICBjb25zdCBwYXJhbXM6IEh0dHBQYXJhbXMgPSBodHRwUGFyYW1zRnJvbUZldGNoUGFyYW1zKGZldGNoUGFyYW1zKTtcbiAqICAgY29uc3Qgb2JzZXJ2YWJsZSA9IHRoaXMuaHR0cC5nZXQ8VD4oXCJodHRwOi8vZXhhbXBsZS5jb21cIiwge3BhcmFtc30pLnBpcGUoc2hhcmUoKSk7XG4gKiAgIHJldHVybiB0aGlzLnJlcXVlc3Qob2JzZXJ2YWJsZSwgbXVsdGljYXN0T3B0aW9ucyk7XG4gKiB9XG4gKi9cblxuZXhwb3J0IGludGVyZmFjZSBNdWx0aWNhc3RPcHRpb25zIHtcbiAgc3ViamVjdD86IGJvb2xlYW47XG4gIGxvYWRlcj86IGJvb2xlYW47XG4gIHN1YnNjcmlwdGlvbj86IGJvb2xlYW47XG4gIG9uRXJyb3I/OiAoZXJyb3I6IGFueSkgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGZXRjaFBhcmFtcyB7XG4gIGxpbWl0PzogbnVtYmVyO1xuICBvZmZzZXQ/OiBudW1iZXI7XG4gIHNvcnQ/OiBzdHJpbmc7XG4gIGw/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVxdWVzdE9wdGlvbnMge1xuICB1cmw/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc011bHRpY2FzdE9wdGlvbnMob2JqZWN0OiBhbnkpOiBvYmplY3QgaXMgTXVsdGljYXN0T3B0aW9ucyB7XG4gIHJldHVybiBvYmplY3QgJiYgKCdzdWJqZWN0JyBpbiBvYmplY3QgfHwgJ2xvYWRlcicgaW4gb2JqZWN0IHx8ICdzdWJzY3JpcHRpb24nIGluIG9iamVjdCB8fCAnb25FcnJvcicgaW4gb2JqZWN0KTtcbn1cblxuLy8gRmV0Y2ggcGFyYW1zIGNhbiBiZSBlbXB0eSBhbmQgcHJvYmFibHkgaXMgbW9zdCBvZiB0aGUgdGltZSwgc28gaGFyZCB0byBjaGVjayB0aGlzIGluIGEgc2lnbmF0dXJlXG5leHBvcnQgZnVuY3Rpb24gaXNGZXRjaFBhcmFtcyhvYmplY3Q6IGFueSk6IG9iamVjdCBpcyBGZXRjaFBhcmFtcyB7XG4gIHJldHVybiBvYmplY3QgJiYgKCdsaW1pdCcgaW4gb2JqZWN0IHx8ICdvZmZzZXQnIGluIG9iamVjdCB8fCAnc29ydCcgaW4gb2JqZWN0IHx8ICdsJyBpbiBvYmplY3QpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNSZXF1ZXN0T3B0aW9ucyhvYmplY3Q6IGFueSk6IG9iamVjdCBpcyBSZXF1ZXN0T3B0aW9ucyB7XG4gIHJldHVybiBvYmplY3QgJiYgKCd1cmwnIGluIG9iamVjdCk7XG59XG5cbmV4cG9ydCB0eXBlIFdzU2VydmljZVJlcXVlc3RQMSA9IEZldGNoUGFyYW1zIHwgTXVsdGljYXN0T3B0aW9ucyB8IFJlcXVlc3RPcHRpb25zO1xuZXhwb3J0IHR5cGUgV3NTZXJ2aWNlUmVxdWVzdFAyID0gTXVsdGljYXN0T3B0aW9ucyB8IFJlcXVlc3RPcHRpb25zO1xuZXhwb3J0IHR5cGUgV3NTZXJ2aWNlUmVxdWVzdFAzID0gUmVxdWVzdE9wdGlvbnM7XG5cbmV4cG9ydCBjb25zdCBGVUxMOiBNdWx0aWNhc3RPcHRpb25zID0ge1xuICBzdWJqZWN0OiB0cnVlLFxuICBsb2FkZXI6IHRydWUsXG4gIHN1YnNjcmlwdGlvbjogdHJ1ZVxufTtcblxuZXhwb3J0IGNvbnN0IExPQURFUl9PTkxZOiBNdWx0aWNhc3RPcHRpb25zID0ge1xuICBsb2FkZXI6IHRydWVcbn07XG5cbmV4cG9ydCBjb25zdCBOT19TVUJKRUNUOiBNdWx0aWNhc3RPcHRpb25zID0ge1xuICBsb2FkZXI6IHRydWUsXG4gIHN1YnNjcmlwdGlvbjogdHJ1ZVxufTtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFdzU2VydmljZTxULCBVIGV4dGVuZHMgRmV0Y2hQYXJhbXMgPSBGZXRjaFBhcmFtcz4ge1xuXG4gIHByaXZhdGUgbG9hZGVycyA9IG5ldyBCZWhhdmlvclN1YmplY3QoMCk7XG4gIHByaXZhdGUgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gPSBudWxsO1xuICBwdWJsaWMgc3ViamVjdCA9IG5ldyBSZXBsYXlTdWJqZWN0PFQ+KDEpO1xuICBwdWJsaWMgbG9hZGluZyA9IG5ldyBSZXBsYXlTdWJqZWN0PGJvb2xlYW4+KDEpO1xuXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmxvYWRlcnMuc3Vic2NyaWJlKG51bUxvYWRlcnMgPT4gdGhpcy5sb2FkaW5nLm5leHQobnVtTG9hZGVycyAhPT0gMCkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIHJlc29sdmVBcmdzKFxuICAgIHAxOiBXc1NlcnZpY2VSZXF1ZXN0UDEsXG4gICAgcDI6IFdzU2VydmljZVJlcXVlc3RQMixcbiAgICBwMzogV3NTZXJ2aWNlUmVxdWVzdFAzLFxuICAgIGRlZmF1bHRNdWx0aWNhc3RPcHRpb25zOiBNdWx0aWNhc3RPcHRpb25zLFxuICAgIGRlZmF1bHRGZXRjaFBhcmFtcz86IFVcbiAgKToge1xuICAgIGZldGNoUGFyYW1zOiBVLFxuICAgIG11bHRpY2FzdE9wdGlvbnM6IE11bHRpY2FzdE9wdGlvbnMsXG4gICAgcmVxdWVzdE9wdGlvbnM6IFJlcXVlc3RPcHRpb25zXG4gIH0ge1xuICAgIGxldCBmZXRjaFBhcmFtczogVTtcbiAgICBsZXQgbXVsdGljYXN0T3B0aW9uczogTXVsdGljYXN0T3B0aW9ucztcbiAgICBsZXQgcmVxdWVzdE9wdGlvbnM6IFJlcXVlc3RPcHRpb25zO1xuICAgIGlmIChpc1JlcXVlc3RPcHRpb25zKHAzKSkge1xuICAgICAgZmV0Y2hQYXJhbXMgPSBwMSBhcyBVO1xuICAgICAgbXVsdGljYXN0T3B0aW9ucyA9IHAyIGFzIE11bHRpY2FzdE9wdGlvbnM7XG4gICAgICByZXF1ZXN0T3B0aW9ucyA9IHAzO1xuICAgIH0gZWxzZSBpZiAoaXNSZXF1ZXN0T3B0aW9ucyhwMikpIHtcbiAgICAgIHJlcXVlc3RPcHRpb25zID0gcDI7XG4gICAgICBpZiAoaXNNdWx0aWNhc3RPcHRpb25zKHAxKSkge1xuICAgICAgICBtdWx0aWNhc3RPcHRpb25zID0gcDE7XG4gICAgICB9IGVsc2UgaWYgKCFpc011bHRpY2FzdE9wdGlvbnMocDEpKSB7XG4gICAgICAgIGZldGNoUGFyYW1zID0gcDEgYXMgVTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGlzUmVxdWVzdE9wdGlvbnMocDEpKSB7XG4gICAgICByZXF1ZXN0T3B0aW9ucyA9IHAxO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaXNNdWx0aWNhc3RPcHRpb25zKHAyKSAmJiAhaXNNdWx0aWNhc3RPcHRpb25zKHAxKSkge1xuICAgICAgICBmZXRjaFBhcmFtcyA9IHAxIGFzIFU7XG4gICAgICAgIG11bHRpY2FzdE9wdGlvbnMgPSBwMjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChpc011bHRpY2FzdE9wdGlvbnMocDEpKSB7XG4gICAgICAgICAgbXVsdGljYXN0T3B0aW9ucyA9IHAxO1xuICAgICAgICB9IGVsc2UgaWYgKCFpc011bHRpY2FzdE9wdGlvbnMocDEpKSB7XG4gICAgICAgICAgZmV0Y2hQYXJhbXMgPSBwMSBhcyBVO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChmZXRjaFBhcmFtcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBmZXRjaFBhcmFtcyA9IGRlZmF1bHRGZXRjaFBhcmFtcztcbiAgICB9XG4gICAgaWYgKG11bHRpY2FzdE9wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgbXVsdGljYXN0T3B0aW9ucyA9IGRlZmF1bHRNdWx0aWNhc3RPcHRpb25zO1xuICAgIH1cbiAgICBpZiAocmVxdWVzdE9wdGlvbnMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmVxdWVzdE9wdGlvbnMgPSB7fTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGZldGNoUGFyYW1zLFxuICAgICAgbXVsdGljYXN0T3B0aW9ucyxcbiAgICAgIHJlcXVlc3RPcHRpb25zXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgaW5jcmVtZW50TG9hZGVyKCk6IHZvaWQge1xuICAgIHRoaXMubG9hZGVycy5waXBlKHRha2UoMSkpLnN1YnNjcmliZSh2ID0+IHtcbiAgICAgIHRoaXMubG9hZGVycy5uZXh0KCsrdik7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGRlY3JlbWVudExvYWRlcigpOiB2b2lkIHtcbiAgICB0aGlzLmxvYWRlcnMucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUodiA9PiB7XG4gICAgICBjb25zdCBsb2FkZXJzID0gTWF0aC5tYXgoMCwgdiAtIDEpO1xuICAgICAgdGhpcy5sb2FkZXJzLm5leHQobG9hZGVycyk7XG4gICAgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgbXVsdGljYXN0KG9ic2VydmFibGU6IE9ic2VydmFibGU8VCB8IFRbXT4sIG9wdGlvbnM6IE11bHRpY2FzdE9wdGlvbnMgPSBGVUxMKTogdm9pZCB7XG4gICAgY29uc3Qge2xvYWRlciwgc3ViamVjdCwgc3Vic2NyaXB0aW9uLCBvbkVycm9yfSA9IG9wdGlvbnM7XG4gICAgaWYgKGxvYWRlcikge1xuICAgICAgdGhpcy5pbmNyZW1lbnRMb2FkZXIoKTtcbiAgICB9XG4gICAgaWYgKHN1YnNjcmlwdGlvbiAmJiB0aGlzLnN1YnNjcmlwdGlvbikge1xuICAgICAgaWYgKGxvYWRlciAmJiAhdGhpcy5zdWJzY3JpcHRpb24uY2xvc2VkKSB7XG4gICAgICAgIHRoaXMuZGVjcmVtZW50TG9hZGVyKCk7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICB9XG4gICAgfVxuICAgIGNvbnN0IHMgPSBvYnNlcnZhYmxlLnN1YnNjcmliZSh2YWx1ZSA9PiB7XG4gICAgICBpZiAobG9hZGVyKSB7XG4gICAgICAgIHRoaXMuZGVjcmVtZW50TG9hZGVyKCk7XG4gICAgICB9XG4gICAgICBpZiAoc3ViamVjdCkge1xuICAgICAgICB0aGlzLnN1YmplY3QubmV4dCh2YWx1ZSBhcyBUKTtcbiAgICAgIH1cbiAgICB9LCBlcnJvciA9PiB7XG4gICAgICBpZiAobG9hZGVyKSB7XG4gICAgICAgIHRoaXMuZGVjcmVtZW50TG9hZGVyKCk7XG4gICAgICB9XG4gICAgICBpZiAob25FcnJvcikge1xuICAgICAgICBvbkVycm9yKGVycm9yKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAoc3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHM7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHJlcXVlc3Qob2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxUPiwgb3B0aW9uczogTXVsdGljYXN0T3B0aW9ucyA9IEZVTEwpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICB0aGlzLm11bHRpY2FzdChvYnNlcnZhYmxlLCBvcHRpb25zKTtcbiAgICByZXR1cm4gb2JzZXJ2YWJsZTtcbiAgfVxuXG4gIHByb3RlY3RlZCByZXF1ZXN0TWFueShvYnNlcnZhYmxlczogQXJyYXk8T2JzZXJ2YWJsZTxUPj4sIG9wdGlvbnM6IE11bHRpY2FzdE9wdGlvbnMgPSBOT19TVUJKRUNUKTogT2JzZXJ2YWJsZTxBcnJheTxUPj4ge1xuICAgIGNvbnN0IGZvcmtKb2luZWQgPSBmb3JrSm9pbihvYnNlcnZhYmxlcyk7XG4gICAgdGhpcy5tdWx0aWNhc3QoZm9ya0pvaW5lZCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIGZvcmtKb2luZWQ7XG4gIH1cblxufVxuIl19